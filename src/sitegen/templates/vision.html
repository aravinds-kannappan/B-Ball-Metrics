{% extends "base.html" %}

{% block title %}Computer Vision - RallyScope{% endblock %}

{% block content %}
<div class="vision-page">
    <section class="page-header">
        <h1>Computer Vision Analysis</h1>
        <p>Tennis serve analysis using advanced computer vision techniques</p>
    </section>

    <section class="vision-overview">
        <div class="section-header">
            <h2>Serve Analysis Pipeline</h2>
            <p>Our computer vision system analyzes tennis serves to extract key metrics</p>
        </div>

        <div class="pipeline-steps">
            <div class="step-card">
                <div class="step-number">1</div>
                <h3>Court Calibration</h3>
                <p>Detect court lines and establish coordinate system using homography transformation</p>
            </div>
            <div class="step-card">
                <div class="step-number">2</div>
                <h3>Ball Tracking</h3>
                <p>Track tennis ball trajectory using background subtraction and color filtering</p>
            </div>
            <div class="step-card">
                <div class="step-number">3</div>
                <h3>Metric Extraction</h3>
                <p>Calculate serve speed, trajectory smoothness, and contact point timing</p>
            </div>
            <div class="step-card">
                <div class="step-number">4</div>
                <h3>Visualization</h3>
                <p>Generate annotated videos showing trajectory and key metrics</p>
            </div>
        </div>
    </section>

    <section class="serve-gallery">
        <div class="section-header">
            <h2>Analyzed Serves</h2>
            <p>Explore serve analysis results from our computer vision pipeline</p>
        </div>

        <div class="serve-stats-overview">
            {% if vision_stats %}
            <div class="stat-card">
                <h3>{{ vision_stats.total_videos|default(0) }}</h3>
                <p>Videos Analyzed</p>
            </div>
            <div class="stat-card">
                <h3>{{ vision_stats.successful_analyses|default(0) }}</h3>
                <p>Successful Analyses</p>
            </div>
            <div class="stat-card">
                <h3>{{ vision_stats.average_speed|round(1) if vision_stats.average_speed else 'N/A' }} km/h</h3>
                <p>Average Serve Speed</p>
            </div>
            {% else %}
            <div class="stat-card">
                <h3>0</h3>
                <p>Videos Analyzed</p>
            </div>
            {% endif %}
        </div>

        <div class="serves-grid">
            {% if vision_results %}
            {% for result in vision_results %}
            {% if result.analysis_success %}
            <div class="serve-card">
                <div class="serve-header">
                    <h3>{{ result.video_name.replace('_', ' ').replace('.mp4', '') }}</h3>
                    <span class="serve-speed">{{ result.metrics.ball_speed_kmh }} km/h</span>
                </div>
                
                {% if result.gif_created %}
                <div class="serve-gif">
                    <img src="assets/vision/{{ result.gif_filename }}" alt="Serve analysis for {{ result.video_name }}" loading="lazy">
                </div>
                {% else %}
                <div class="serve-placeholder">
                    <p>Visualization not available</p>
                </div>
                {% endif %}

                <div class="serve-metrics">
                    <div class="metric-row">
                        <span class="metric-label">Ball Speed:</span>
                        <span class="metric-value">{{ result.metrics.ball_speed_kmh }} km/h</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Direction:</span>
                        <span class="metric-value">{{ result.metrics.serve_direction|title }}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Trajectory Smoothness:</span>
                        <span class="metric-value">{{ (result.metrics.trajectory_smoothness * 100)|round(1) }}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Contact Frame:</span>
                        <span class="metric-value">{{ result.metrics.contact_frame }}</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Total Time:</span>
                        <span class="metric-value">{{ result.metrics.total_time_seconds }}s</span>
                    </div>
                </div>

                <button class="details-btn" onclick="showServeDetails('{{ loop.index0 }}')">View Details</button>
            </div>
            {% endif %}
            {% endfor %}
            {% else %}
            <div class="no-data-message">
                <h3>No Analysis Results</h3>
                <p>Run the computer vision pipeline to analyze serve videos and generate results.</p>
                <div class="sample-explanation">
                    <h4>Sample Analysis Features:</h4>
                    <ul>
                        <li>Ball speed calculation using court calibration</li>
                        <li>Serve trajectory tracking and smoothness analysis</li>
                        <li>Toss height and contact point detection</li>
                        <li>Direction and placement analysis</li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </section>

    <section class="methodology">
        <div class="section-header">
            <h2>Technical Methodology</h2>
            <p>How our computer vision system works</p>
        </div>

        <div class="methodology-content">
            <div class="method-section">
                <h3>Court Calibration</h3>
                <p>We use computer vision to detect court lines and establish a homography transformation that maps pixel coordinates to real-world court coordinates. This enables accurate distance and speed measurements.</p>
                <ul>
                    <li>Edge detection using Canny edge detector</li>
                    <li>Line detection with Hough transform</li>
                    <li>Homography calculation from court corners</li>
                    <li>Real-world coordinate transformation</li>
                </ul>
            </div>

            <div class="method-section">
                <h3>Ball Tracking</h3>
                <p>Tennis ball detection combines multiple computer vision techniques to reliably track the ball throughout the serve motion, even with challenging lighting and background conditions.</p>
                <ul>
                    <li>Background subtraction for motion detection</li>
                    <li>HSV color filtering for yellow ball detection</li>
                    <li>Contour analysis for shape validation</li>
                    <li>Trajectory smoothing and interpolation</li>
                </ul>
            </div>

            <div class="method-section">
                <h3>Metric Calculation</h3>
                <p>From the tracked ball trajectory, we extract meaningful tennis metrics that provide insights into serve quality and technique.</p>
                <ul>
                    <li>Ball speed using court-calibrated distances</li>
                    <li>Toss height from trajectory peak detection</li>
                    <li>Contact point timing analysis</li>
                    <li>Trajectory smoothness scoring</li>
                </ul>
            </div>

            <div class="method-section">
                <h3>Limitations & Future Work</h3>
                <p>Current implementation is a proof-of-concept with several areas for improvement:</p>
                <ul>
                    <li>Manual court calibration (could be automated)</li>
                    <li>Single camera view (could use multiple angles)</li>
                    <li>Simplified ball tracking (could use deep learning)</li>
                    <li>Basic metrics (could add spin analysis, placement prediction)</li>
                </ul>
            </div>
        </div>
    </section>

    <!-- Serve Details Modal -->
    <section class="serve-details-modal" id="serve-modal" style="display: none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div id="serve-details-content">
                <!-- Serve details will be populated here -->
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Vision results data
    const visionResults = {{ vision_results|tojson if vision_results else '[]' }};

    document.addEventListener('DOMContentLoaded', function() {
        setupServeModal();
    });

    function showServeDetails(resultIndex) {
        const result = visionResults[resultIndex];
        if (!result) return;

        const modal = document.getElementById('serve-modal');
        const content = document.getElementById('serve-details-content');
        
        content.innerHTML = `
            <h2>${result.video_name.replace('_', ' ').replace('.mp4', '')}</h2>
            
            <div class="serve-details-grid">
                <div class="detail-section">
                    <h3>Performance Metrics</h3>
                    <div class="metrics-table">
                        <div class="metric-row">
                            <span class="label">Ball Speed:</span>
                            <span class="value">${result.metrics.ball_speed_kmh} km/h</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Serve Direction:</span>
                            <span class="value">${result.metrics.serve_direction}</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Trajectory Smoothness:</span>
                            <span class="value">${(result.metrics.trajectory_smoothness * 100).toFixed(1)}%</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Toss Height (pixels):</span>
                            <span class="value">${result.metrics.toss_height_pixels}</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Contact Frame:</span>
                            <span class="value">${result.metrics.contact_frame}</span>
                        </div>
                        <div class="metric-row">
                            <span class="label">Total Duration:</span>
                            <span class="value">${result.metrics.total_time_seconds}s</span>
                        </div>
                    </div>
                </div>

                <div class="detail-section">
                    <h3>Analysis Details</h3>
                    <div class="analysis-info">
                        <p><strong>Frames Analyzed:</strong> ${result.frames_analyzed}</p>
                        <p><strong>Trajectory Points:</strong> ${result.trajectory_points}</p>
                        <p><strong>Court Calibrated:</strong> ${result.court_calibrated ? 'Yes' : 'No'}</p>
                        <p><strong>GIF Generated:</strong> ${result.gif_created ? 'Yes' : 'No'}</p>
                    </div>
                </div>

                ${result.gif_created ? `
                <div class="detail-section full-width">
                    <h3>Annotated Analysis</h3>
                    <div class="full-gif-display">
                        <img src="assets/vision/${result.gif_filename}" alt="Full serve analysis" style="max-width: 100%;">
                    </div>
                </div>
                ` : ''}
            </div>

            <div class="performance-insights">
                <h3>Performance Insights</h3>
                <div class="insights-list">
                    <div class="insight-item">
                        <strong>Speed Rating:</strong> ${getSpeedRating(result.metrics.ball_speed_kmh)}
                    </div>
                    <div class="insight-item">
                        <strong>Trajectory Quality:</strong> ${getTrajectoryQuality(result.metrics.trajectory_smoothness)}
                    </div>
                    <div class="insight-item">
                        <strong>Timing:</strong> ${getTimingAnalysis(result.metrics.contact_frame, result.metrics.toss_peak_frame)}
                    </div>
                </div>
            </div>
        `;

        modal.style.display = 'block';
    }

    function getSpeedRating(speed) {
        if (speed > 190) return 'Excellent (190+ km/h)';
        if (speed > 170) return 'Good (170-190 km/h)';
        if (speed > 150) return 'Average (150-170 km/h)';
        return 'Below Average (<150 km/h)';
    }

    function getTrajectoryQuality(smoothness) {
        if (smoothness > 0.9) return 'Excellent - Very smooth trajectory';
        if (smoothness > 0.8) return 'Good - Mostly smooth with minor variations';
        if (smoothness > 0.7) return 'Average - Some trajectory irregularities';
        return 'Below Average - Erratic trajectory';
    }

    function getTimingAnalysis(contactFrame, tossPeakFrame) {
        const timingDiff = contactFrame - tossPeakFrame;
        if (timingDiff >= 2 && timingDiff <= 4) {
            return 'Good - Optimal timing between toss peak and contact';
        } else if (timingDiff < 2) {
            return 'Early - Contact slightly before optimal timing';
        } else {
            return 'Late - Contact after optimal timing window';
        }
    }

    function setupServeModal() {
        const modal = document.getElementById('serve-modal');
        const closeBtn = document.querySelector('.close-modal');

        closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}